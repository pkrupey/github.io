<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.19" />
    <style>
      :root {
        --vp-c-bg: #fff;
      }

      [data-theme='dark'] {
        --vp-c-bg: #1b1b1f;
      }

      html,
      body {
        background-color: var(--vp-c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme')
      const systemDarkMode =
        'matchMedia' in window
          ? window.matchMedia('(prefers-color-scheme: dark)').matches
          : false

      if (userMode === 'light') {
        document.documentElement.dataset.theme = 'light'
      } else if (userMode === 'dark' || systemDarkMode) {
        document.documentElement.dataset.theme = 'dark'
      }
    </script>
    <title>Table of Contents | Tidypay Payment Application Integration</title><meta name="description" content="Tidypay Payment Application Integration with POS">
    <link rel="preload" href="assets/style-PoWje89h.css" as="style"><link rel="stylesheet" href="assets/style-PoWje89h.css">
    <link rel="modulepreload" href="assets/app-DFSrrxbA.js"><link rel="modulepreload" href="assets/index.html-DtmD4iAm.js">
    <link rel="prefetch" href="assets/404.html-B7VvLRTN.js" as="script"><link rel="prefetch" href="assets/setupDevtools-7MC2TMWH-BKXbqx1y.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="vp-theme-container external-link-icon" vp-container><!--[--><header class="vp-navbar" vp-navbar><div class="vp-toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a class="route-link" href><img class="vp-site-logo" src="https://vuejs.press/images/hero.png" alt="Tidypay Payment Application Integration"><span class="vp-site-name vp-hide-mobile" aria-hidden="true">Tidypay Payment Application Integration</span></a></span><div class="vp-navbar-items-wrapper" style=""><!--[--><!--]--><nav class="vp-navbar-items vp-hide-mobile" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link route-link-active auto-link" href aria-label="Table of Contents"><!---->Table of Contents<!----></a></div><!--]--></nav><!--[--><!--]--><button type="button" class="vp-toggle-color-mode-button" title="toggle color mode"><svg class="light-icon" viewbox="0 0 32 32" style=""><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg class="dark-icon" viewbox="0 0 32 32" style="display:none;"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="vp-sidebar-mask"></div><!--[--><aside class="vp-sidebar" vp-sidebar><nav class="vp-navbar-items" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link route-link-active auto-link" href aria-label="Table of Contents"><!---->Table of Contents<!----></a></div><!--]--></nav><!--[--><!--]--><ul class="vp-sidebar-items"><!--[--><li><p tabindex="0" class="vp-sidebar-item vp-sidebar-heading">Table of Contents <!----></p><!----></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="vp-page"><!--[--><!--]--><div class="theme-default-content" vp-content><!--[--><!--]--><div><h1 id="table-of-contents" tabindex="-1"><a class="header-anchor" href="#table-of-contents"><span>Table of Contents</span></a></h1><ul><li><a href="#introduction">Introduction</a></li><li><a href="#terms-and-definitions">Terms and Definitions</a></li><li><a href="#terminalapp-configuration">TerminalApp Configuration</a></li><li><a href="#source-code-examples">Source Code Examples</a></li><li><a href="#communication-protocol">Communication Protocol</a><ul><li><a href="#data-flow">Data flow</a></li><li><a href="#framework">Framework</a></li><li><a href="#data-structures">Data structures</a></li></ul></li><li><a href="#functions">Functions</a><ul><li><a href="#sale">Sale</a></li><li><a href="#sale-auth">Sale Auth</a></li><li><a href="#capture">Capture</a></li><li><a href="#voidrefund">Void/Refund</a></li><li><a href="#find">Find</a></li><li><a href="#close-batch">Close Batch</a></li><li><a href="#transaction-reports">Transaction Reports</a></li></ul></li><li><a href="#integration-modes">Integration Modes</a><ul><li><a href="#managed-mode-app-to-app-switching">Managed Mode</a></li><li><a href="#proxy-mode">Proxy Mode</a></li></ul></li><li><a href="#broadcastreceiver-integration">Broadcast Receiver Integration</a><ul><li><a href="#transaction-responses">Transaction Responses</a></li><li><a href="#status-notifications">Status Notifications</a></li><li><a href="#comparison-of-integration-modes">Comparison of Integration Modes</a></li></ul></li><li><a href="#cross-cutting-concerns">Cross-cutting Concerns</a><ul><li><a href="#api-authentification">API Authentication</a></li><li><a href="#identification-of-the-transactions">Transaction Identification</a></li><li><a href="#duplicate-transaction-handling">Duplicate Transaction Handling</a></li></ul></li></ul><h1 id="introduction" tabindex="-1"><a class="header-anchor" href="#introduction"><span>Introduction</span></a></h1><p>This document outlines integration strategies for Tidypay&#39;s payment application with POS systems. It focuses on the communication protocol, primary modes of integration: <strong>Managed Mode</strong>, <strong>Proxy Mode</strong>, and communication using <strong>BroadcastReceiver</strong>.</p><h1 id="terms-and-definitions" tabindex="-1"><a class="header-anchor" href="#terms-and-definitions"><span>Terms and Definitions</span></a></h1><table><thead><tr><th>Term</th><th>Description</th></tr></thead><tbody><tr><td>Terminal App</td><td>Payment application provided by Tidypay</td></tr><tr><td>POS Client Demo</td><td>POS demo application supplied by Tidypay meant to host an example of the integration with Terminal App in different modes of operation.</td></tr><tr><td>POS</td><td>Point-Of-Sale system of the integrator</td></tr><tr><td>ProxyApp</td><td>Lightweight application that gets installed side-side with Terminal App to facilitate data exchange between the remote POS system and the Terminal App.</td></tr><tr><td>TMS</td><td>Terminal Management System</td></tr></tbody></table><h1 id="terminalapp-configuration" tabindex="-1"><a class="header-anchor" href="#terminalapp-configuration"><span>TerminalApp Configuration</span></a></h1><p>To ensure proper functionality of the Terminal App, the network and firewall settings shall be configured according to the following requirements:</p><ol><li><p>Internet Connectivity Checks:</p><p>a. The <em>Terminal App</em> verifies internet availability by pinging the following addresses:</p><ol><li><em>http://google.com</em></li><li><em>8.8.8.8</em></li></ol></li><li><p>TMS Requests:</p><p>a. <em>Host: TMS host</em></p><p>b. <em>Port: 443</em></p></li><li><p>Transaction Processing:</p><p>a. <em>Host: GatewayHost</em></p><p>b. <em>Port: 443</em></p></li></ol><h1 id="source-code-examples" tabindex="-1"><a class="header-anchor" href="#source-code-examples"><span>Source Code Examples</span></a></h1><p><img src="/assets/xgY_Image_1-DVXgk0u9.png" alt="Enter image alt description"></p><p>POS Client demo Android application that interacts with Terminal App in different modes.</p><p>In <em>Tools</em> folder there is the <em>Proxy app.zip</em> that contains</p><ul><li><p>A simple demo proxy application.</p></li><li><p>Java PC program that can be used to test connections from a PC to a payment device.</p></li></ul><h1 id="communication-protocol" tabindex="-1"><a class="header-anchor" href="#communication-protocol"><span>Communication protocol</span></a></h1><h2 id="data-flow" tabindex="-1"><a class="header-anchor" href="#data-flow"><span>Data flow</span></a></h2><p><img src="/assets/c5H_Image_2-Bq-u2eWS.png" alt="Enter image alt description"></p><h2 id="framework" tabindex="-1"><a class="header-anchor" href="#framework"><span>Framework</span></a></h2><p>The typical communication flow with using Android <em>Intents</em> to be executed between the integrator’s POS system and the Terminal App incurs the following phases:</p><ol><li>Registration of <em>Intent</em> for handling API requests.</li></ol><p>Enable querying of installed applications on the device by either enabling All or selective through package names.</p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>manifest</span> <span class="token attr-name"><span class="token namespace">xmlns:</span>android</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://schemas.android.com/apk/res/android<span class="token punctuation">&quot;</span></span></span>
<span class="line">    <span class="token attr-name"><span class="token namespace">xmlns:</span>tools</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://schemas.android.com/tools<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>queries</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>package</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>com.tidypos.terminal<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>package</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>com.tidypay.softpos<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>queries</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    ...</span>
<span class="line">    <span class="token comment">&lt;!-- or --&gt;</span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>uses-permission</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>android.permission.QUERY_ALL_PACKAGES<span class="token punctuation">&quot;</span></span></span>
<span class="line">        <span class="token attr-name"><span class="token namespace">tools:</span>ignore</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>QueryAllPackagesPermission<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span></span>
<span class="line">    ...</span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>manifest</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>Execute payment function</li></ol><p>Start Terminal App by passing the command to execute via the <em>Intent</em>. To do this, the activity with the method</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"> <span class="token function">startActivityForResult</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> <span class="token constant">REQUEST_CODE</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>shall be used. The <em>REQUEST_CODE</em> is a user-defined integer code.The response will be received in the <em>onActivityResult</em> method of the current activity, the prototype of which looks as follows:</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token function">onActivityResult</span><span class="token punctuation">(</span><span class="token keyword">int</span> requestCode<span class="token punctuation">,</span> <span class="token keyword">int</span> resultCode<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Intent</span> data<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ol start="3"><li>Reading information from the data intent on the POS side.</li></ol><p>The accepted intent has a mandatory <em><strong>extras</strong></em> object named <em><strong>response</strong></em> containing a <em>Map&lt;String, String&gt;</em>. The data can be obtained as follows</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> responseMap <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> data<span class="token punctuation">.</span><span class="token function">getSerializableExtra</span><span class="token punctuation">(</span><span class="token string">&quot;response&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>If the <em><strong>dataType</strong></em> key is present in the map and its string value is equal to &#39;<em>list</em>&#39;, then the <em>intent</em> should have a second <em>extras</em> named &#39;<em>data</em>&#39; containing data on the previously sent request. The data itself is a <em>Uri</em> type containing a link to the file with the processing result.</p><p>The data can be obtained as follows:</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token class-name">Uri</span> receivedUri <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getParcelableExtra</span><span class="token punctuation">(</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>In case of the presence of a second <em>extras</em> object, the map also contains the <em>’dataChecksum’</em>&#39; field, which contains the checksum of the file calculated by the SHA1 algorithm.</p><ol start="4"><li>Loading the generated file from a response</li></ol><p>The generated file with the result is loaded through an &#39;<em>InputStream</em>&#39; object, which is obtained using the <em>getContentResolver().openInputStream(receivedUri)</em> method. Previously received shall be passed as an input param.</p><p>The full example of the process that involves handling a list of data populated is presented in the <a href="?tab=t.0#heading=h.gprzn31rujuv">Transaction reports</a>.</p><p>The back channel data flow with real-time notifications and updates about payment progress from Terminal App to POS is described in <a href="?tab=t.0#heading=h.yymahntg8j7j">BroadcastReceiver Integration</a>.</p><h2 id="data-structures" tabindex="-1"><a class="header-anchor" href="#data-structures"><span>Data structures</span></a></h2><p>Regardless of the integration mode, the data fields used to populate requests and responses are specified in <a href="https://tidypay.gatewayaid.com/processing-api/terminal/operations" target="_blank" rel="noopener noreferrer">Tidypay Terminal API</a> depending on the request being made.</p><blockquote><p><strong>Note!</strong> Even though required in the API specification, accountId and transactionId fields can be skipped from transmission in POS because Terminal App is capable of figuring them out based on the configuration applied. This applies to all methods with a few exceptions to be highlighted individually.</p></blockquote><p>All API requests, regardless of a type, include a <em><strong>response</strong></em> data structure. However, the requests with an attachment, which deal with larger data volumes, also include a <em><strong>data</strong></em> structure. This <em><strong>data</strong></em> structure contains a URI linking to an attachment and is included in addition to the usual <em><strong>response</strong></em> structure.</p><p>The <em><strong>data</strong></em> structure in the response provides the URI to this temporary file containing the data. This <em><strong>data</strong></em> structure is sent alongside the <em><strong>response</strong></em> structure in the API response.</p><p>Besides the standard fields described in the specification, the terminal adds two additional fields in the <em><strong>response</strong></em> structure:</p><p>● <em>dataType</em>: indicates the format of the response (details below).</p><p>● <em>dataChecksum</em>: a checksum that can be used to validate the integrity of the attachment, if the last is included in the <em><strong>data</strong></em> structure.</p><p>The <em>dataType</em> field indicates how to interpret the response:</p><p>● &#39;<em>no data</em>&#39;- there is nothing to analyze, the request returns no information.</p><p>● &#39;<em>error</em>&#39;- the response generates an error. Details can be found in the <em>responseCode</em> and <em>responseMessage</em> fields.</p><p>● &#39;<em>detail</em>&#39; (default type) - the response should be interpreted according to the format described in the<a href="https://tidypay.gatewayaid.com/processing-api/terminal/operations" target="_blank" rel="noopener noreferrer"></a><a href="https://tidypay.gatewayaid.com/processing-api/terminal/operations" target="_blank" rel="noopener noreferrer">Tidypay Terminal API</a> API documentation.</p><p>● &#39;<em>list</em>&#39;- the response includes an attachment with the list of data in JSON format, and the data should be handled accordingly. This data type is used in transaction reporting functions.</p><h1 id="functions" tabindex="-1"><a class="header-anchor" href="#functions"><span>Functions</span></a></h1><h2 id="sale" tabindex="-1"><a class="header-anchor" href="#sale"><span>Sale</span></a></h2><h3 id="api-format" tabindex="-1"><a class="header-anchor" href="#api-format"><span>API format</span></a></h3><p><a href="https://tidypay.gatewayaid.com/processing-api/terminal/operations#operation-sale-terminal" target="_blank" rel="noopener noreferrer">Sale</a></p><h3 id="example" tabindex="-1"><a class="header-anchor" href="#example"><span>Example</span></a></h3><p>Please refer to <a href="?tab=t.0#heading=h.hcrajvxt8b69">Example Of Sale in Managed mode</a> in the managed mode and <a href="?tab=t.0#heading=h.yzvlyqucn8p">Example of Sale in Proxy mode</a></p><h2 id="sale-auth" tabindex="-1"><a class="header-anchor" href="#sale-auth"><span>Sale Auth</span></a></h2><h3 id="api-format-1" tabindex="-1"><a class="header-anchor" href="#api-format-1"><span>API format</span></a></h3><p><a href="https://tidypay.gatewayaid.com/processing-api/terminal/operations#operation-sale-auth-terminal" target="_blank" rel="noopener noreferrer">Sale Auth</a></p><h3 id="example-1" tabindex="-1"><a class="header-anchor" href="#example-1"><span>Example</span></a></h3><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token comment">// Analogous to a Sale command example except request type being different as a line below</span></span>
<span class="line">params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">TerminalReq<span class="token punctuation">.</span>RequestType</span><span class="token punctuation">,</span> <span class="token class-name">RequestType<span class="token punctuation">.</span>SaleAuth</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="capture" tabindex="-1"><a class="header-anchor" href="#capture"><span>Capture</span></a></h2><h3 id="api-format-2" tabindex="-1"><a class="header-anchor" href="#api-format-2"><span>API format</span></a></h3><p><a href="https://tidypay.gatewayaid.com/processing-api/terminal/operations#operation-capture-terminal" target="_blank" rel="noopener noreferrer">Capture</a></p><h3 id="example-2" tabindex="-1"><a class="header-anchor" href="#example-2"><span>Example</span></a></h3><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">processCapture</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">MainApp</span> app <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">MainApp</span><span class="token punctuation">)</span> <span class="token function">getApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token class-name">TransactionResponse</span> latest <span class="token operator">=</span> app<span class="token punctuation">.</span><span class="token function">getLatestTransactionResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>latest <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> latest<span class="token punctuation">.</span><span class="token function">getResponseType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">RequestType<span class="token punctuation">.</span>SaleAuth</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">TerminalAPI</span><span class="token punctuation">.</span><span class="token function">setCredentials</span><span class="token punctuation">(</span><span class="token constant">API_TIDYPAY_CREDENTIALS</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FieldName</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> params <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">TerminalReq<span class="token punctuation">.</span>RequestType</span><span class="token punctuation">,</span> <span class="token class-name">RequestType<span class="token punctuation">.</span>Capture</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">TerminalReq<span class="token punctuation">.</span>TransactionId</span><span class="token punctuation">,</span> latest<span class="token punctuation">.</span><span class="token function">getTransactionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">TerminalAPI</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> params<span class="token punctuation">,</span> <span class="token class-name">TerminalAPI</span><span class="token punctuation">.</span><span class="token constant">CAPTURE_REQUEST_CODE</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p><strong>Note!</strong> The TransactionId field is mandatory for the Capture function. Typically, POS is going to cache the response of the Sale-Auth transaction and use it whenever Capture is invoked..</p></blockquote><h2 id="void-refund" tabindex="-1"><a class="header-anchor" href="#void-refund"><span>Void/Refund</span></a></h2><h3 id="api-format-3" tabindex="-1"><a class="header-anchor" href="#api-format-3"><span>API format</span></a></h3><p><a href="https://tidypay.gatewayaid.com/processing-api/terminal/operations#operation-void-terminal" target="_blank" rel="noopener noreferrer">Void</a> and <a href="https://tidypay.gatewayaid.com/processing-api/terminal/operations#operation-refund-terminal" target="_blank" rel="noopener noreferrer">Refund</a>.</p><h3 id="example-3" tabindex="-1"><a class="header-anchor" href="#example-3"><span>Example</span></a></h3><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">processRefundRequest</span><span class="token punctuation">(</span><span class="token class-name">String</span> transactionId<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">TerminalAPI</span><span class="token punctuation">.</span><span class="token function">setCredentials</span><span class="token punctuation">(</span><span class="token constant">API_TIDYPAY_CREDENTIALS</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FieldName</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> params <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">TerminalReq<span class="token punctuation">.</span>RequestType</span><span class="token punctuation">,</span> <span class="token class-name">RequestType<span class="token punctuation">.</span>Refund</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">TerminalReq<span class="token punctuation">.</span>TransactionId</span><span class="token punctuation">,</span> transactionId<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token class-name">TerminalAPI</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> params<span class="token punctuation">,</span> <span class="token class-name">TerminalAPI</span><span class="token punctuation">.</span><span class="token constant">REQUEST_CODE</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p><strong>Note!</strong> The TransactionId field is mandatory and Transaction Code is optional.</p></blockquote><blockquote><p><strong>Note!</strong> No matter what exactly is put into the <em>Request Type</em> field, Terminal App works out whether the Void or Refund gets applied depending on the transaction status, e.i, if it was settled already or not.</p></blockquote><h3 id="voiding-logic" tabindex="-1"><a class="header-anchor" href="#voiding-logic"><span>Voiding Logic</span></a></h3><p>Voiding logic is designed so that if the terminal is uncertain about the status of a previous transaction then it will send a <em>Void</em> request for this transaction to the Gateway. In the gateway the status might indeed be approved but this has not reached the terminal. The voiding logic does not kick in before another action is taken in the Terminal App itself like performing a transaction request, running Get parameters, or something else that validates the connection to the Gateway.</p><p><em>Find</em> requests can be used in the background of the POS system to fire off the validation to the Gateway prematurely without waiting for a subsequent transaction to occur.</p><p>Please refer to the <a href="#find">Find</a> section for more information about the *Find *function.</p><h2 id="find" tabindex="-1"><a class="header-anchor" href="#find"><span>Find</span></a></h2><p><em>Find</em> request allows to fetch the status of the existing transaction - both settled and unsettled.</p><h3 id="api-format-4" tabindex="-1"><a class="header-anchor" href="#api-format-4"><span>API format</span></a></h3><p><a href="https://tidypay.gatewayaid.com/processing-api/terminal/operations#operation-find-terminal" target="_blank" rel="noopener noreferrer">Find</a></p><h3 id="example-4" tabindex="-1"><a class="header-anchor" href="#example-4"><span>Example</span></a></h3><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">processFindRequest</span><span class="token punctuation">(</span><span class="token class-name">String</span> transactionCode<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">TerminalAPI</span><span class="token punctuation">.</span><span class="token function">setCredentials</span><span class="token punctuation">(</span><span class="token constant">API_TIDYPAY_CREDENTIALS</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FieldName</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> params <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">TerminalReq<span class="token punctuation">.</span>RequestType</span><span class="token punctuation">,</span> <span class="token class-name">RequestType<span class="token punctuation">.</span>Find</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">TerminalReq<span class="token punctuation">.</span>TransactionCode</span><span class="token punctuation">,</span> transactionCode<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token class-name">TerminalAPI</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> params<span class="token punctuation">,</span> <span class="token class-name">TerminalAPI</span><span class="token punctuation">.</span><span class="token constant">FIND_REQUEST_CODE</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="close-batch" tabindex="-1"><a class="header-anchor" href="#close-batch"><span>Close batch</span></a></h2><h3 id="api-format-5" tabindex="-1"><a class="header-anchor" href="#api-format-5"><span>API format</span></a></h3><p><a href="https://tidypay.gatewayaid.com/processing-api/terminal/operations#operation-close-cycle-terminal" target="_blank" rel="noopener noreferrer">Close cycle</a></p><h3 id="example-5" tabindex="-1"><a class="header-anchor" href="#example-5"><span>Example</span></a></h3><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">processCloseCycleRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">TerminalAPI</span><span class="token punctuation">.</span><span class="token function">setCredentials</span><span class="token punctuation">(</span><span class="token constant">API_TIDYPAY_CREDENTIALS</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FieldName</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> params <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">TerminalReq<span class="token punctuation">.</span>RequestType</span><span class="token punctuation">,</span> <span class="token class-name">RequestType<span class="token punctuation">.</span>CloseCycle</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">TerminalAPI</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> params<span class="token punctuation">,</span> <span class="token class-name">TerminalAPI</span><span class="token punctuation">.</span><span class="token constant">REQUEST_CODE</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="transaction-reports" tabindex="-1"><a class="header-anchor" href="#transaction-reports"><span>Transaction reports</span></a></h2><h3 id="api-format-6" tabindex="-1"><a class="header-anchor" href="#api-format-6"><span>API format</span></a></h3><p><a href="https://tidypay.gatewayaid.com/processing-api/terminal/operations#operation-transaction-list-terminal" target="_blank" rel="noopener noreferrer">Transaction List</a> and <a href="https://tidypay.gatewayaid.com/processing-api/terminal/operations#operation-transaction-summary-by-day-terminal" target="_blank" rel="noopener noreferrer">Transaction Summary of the day</a></p><h3 id="example-6" tabindex="-1"><a class="header-anchor" href="#example-6"><span>Example</span></a></h3><p>The <em>Transaction List</em> API data flow and extraction can be viewed in the following pseudo code snippet. It implements the scenario that:</p><ul><li><p>Searches for all the &#39;<em>Unsettled</em>&#39; transactions made on the given terminal within the last <strong>30 minutes</strong>.</p></li><li><p>EST time zone is facilitated. This time zone is set by default in the Sandbox environment.</p></li><li><p>The received &#39;<em>list</em>&#39; of transactions gets downloaded in JSON format.</p></li><li><p>Checksum calculations, exception handling, and processing the results of the reports are omitted for the sake of simplicity.</p></li></ul><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">processTransactionReportRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">TerminalAPI</span><span class="token punctuation">.</span><span class="token function">setCredentials</span><span class="token punctuation">(</span><span class="token constant">API_TIDYPAY_CREDENTIALS</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FieldName</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> params <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">TerminalReq<span class="token punctuation">.</span>RequestType</span><span class="token punctuation">,</span> <span class="token class-name">RequestType<span class="token punctuation">.</span>TransactionList</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">TerminalReq<span class="token punctuation">.</span>SettlementStatus</span><span class="token punctuation">,</span> <span class="token string">&quot;unsettled&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">TerminalReq<span class="token punctuation">.</span>ReportBasis</span><span class="token punctuation">,</span> <span class="token string">&quot;authorizationDate&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">TerminalReq<span class="token punctuation">.</span>AccountId</span><span class="token punctuation">,</span> <span class="token number">6001</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">TerminalReq<span class="token punctuation">.</span>TerminalId</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// Get the current time in UTC</span></span>
<span class="line">    <span class="token class-name">Calendar</span> calendar <span class="token operator">=</span> <span class="token class-name">Calendar</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token class-name">TimeZone</span><span class="token punctuation">.</span><span class="token function">getTimeZone</span><span class="token punctuation">(</span><span class="token string">&quot;UTC&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">SimpleDateFormat</span> formatter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string">&quot;yyyyMMddHHmmss&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// Change the time zone to EST. This is for Sandbox environment only</span></span>
<span class="line">    formatter<span class="token punctuation">.</span><span class="token function">setTimeZone</span><span class="token punctuation">(</span><span class="token class-name">TimeZone</span><span class="token punctuation">.</span><span class="token function">getTimeZone</span><span class="token punctuation">(</span><span class="token string">&quot;EST&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">String</span> toTime <span class="token operator">=</span> formatter<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>calendar<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// Subtract 30 minutes from the current time</span></span>
<span class="line">    calendar<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">Calendar</span><span class="token punctuation">.</span><span class="token constant">MINUTE</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">String</span> fromTime <span class="token operator">=</span> formatter<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>calendar<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">TerminalReq<span class="token punctuation">.</span>ReportFromDate</span><span class="token punctuation">,</span> fromTime<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">TerminalReq<span class="token punctuation">.</span>ReportToDate</span><span class="token punctuation">,</span> toTime<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token class-name">TerminalAPI</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> params<span class="token punctuation">,</span> <span class="token class-name">TerminalAPI</span><span class="token punctuation">.</span><span class="token constant">REPORT_REQUEST_CODE</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">processTransactionReportResponse</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> resultCode<span class="token punctuation">,</span> <span class="token class-name">Intent</span> intent<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FieldName</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> responseMap <span class="token operator">=</span> <span class="token class-name">TerminalAPI</span><span class="token punctuation">.</span><span class="token function">getResponseParameters</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">String</span> checkSum <span class="token operator">=</span> responseMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">TerminalRes<span class="token punctuation">.</span>DataChecksumType</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">int</span> countOfTransactions <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;list&quot;</span><span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>responseMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">TerminalRes<span class="token punctuation">.</span>DataType</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">Uri</span> receivedUri <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getParcelableExtra</span><span class="token punctuation">(</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>receivedUri <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">InputStream</span> inputStream <span class="token operator">=</span> <span class="token function">getContentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">openInputStream</span><span class="token punctuation">(</span>receivedUri<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                 <span class="token class-name">BufferedReader</span> reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InputStreamReader</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token class-name">StringBuilder</span> stringBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token class-name">String</span> line<span class="token punctuation">;</span></span>
<span class="line">                <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>line <span class="token operator">=</span> reader<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    stringBuilder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">                <span class="token class-name">String</span> jsonString <span class="token operator">=</span> stringBuilder<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token comment">// TODO: Check the integrity by calculating the SHA1 checksum of the received file against the value transmitted in the main &#39;response&#39;</span></span>
<span class="line">                <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token class-name">JSONArray</span> jsonArray <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JSONArray</span><span class="token punctuation">(</span>jsonString<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    countOfTransactions <span class="token operator">=</span> jsonArray<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token function">getContentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>receivedUri<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">JSONException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token comment">// Handle JSON parsing error</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token comment">// Handle Parsing error</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token comment">// ...</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p><strong>Note!</strong> As opposed to other requests, among the mandatory input arguments, ‘accountId’ and ‘terminalId’ are present that accurately match the configured Terminal App on the given device. Without correctly specifying those, Terminal App will reject the request with the error message similar to this ‘User name or password are incorrect.’ A very common scenario for obtaining the required fields would be to extract them from a Sale transaction responses and use them eventually in Transaction report queries.</p></blockquote><h1 id="integration-modes" tabindex="-1"><a class="header-anchor" href="#integration-modes"><span>Integration Modes</span></a></h1><h2 id="managed-mode-app-to-app-switching" tabindex="-1"><a class="header-anchor" href="#managed-mode-app-to-app-switching"><span>Managed Mode (App-to-App Switching)</span></a></h2><h3 id="overview" tabindex="-1"><a class="header-anchor" href="#overview"><span>Overview</span></a></h3><p>Managed mode implies installing a POS application on the terminal where the Terminal App resides. The illustration below shows how the interactions between POS and Tidypay components take place in this mode:</p><p><img src="/assets/ljl_Image_3-CNmEEvQj.png" alt="Enter image alt description"></p><p>When POS attempts to make a payment transaction, the Intent with transaction details such as Amount, Transaction Code, etc. is sent to the Terminal App. Terminal App becomes a foreground process that completes the transaction before returning back a control to POS.</p><p>Apparently, the POS application runs in the background while payments and other operations get processed.</p><h3 id="features" tabindex="-1"><a class="header-anchor" href="#features"><span>Features:</span></a></h3><ul><li><p>High-speed transaction processing with excellent stability.</p></li><li><p>Commonly used in mobile POS setups or all-in-one solutions.</p></li><li><p>Operations supported include: <em>Sale, Refund, Void, Close Cycle, Find</em> and others.</p></li></ul><h3 id="technical-considerations" tabindex="-1"><a class="header-anchor" href="#technical-considerations"><span>Technical Considerations</span></a></h3><p>Managed Mode relies on Android&#39;s Intent mechanism to facilitate communication between the POS app and the Terminal App.</p><p>The following code snippets below outline the principle of delegation of the *Sale *transaction request to the Terminal App alongside the processing of a response delivered when the transaction is finished.</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">processSaleRequest</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> amount<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">TerminalAPI</span><span class="token punctuation">.</span><span class="token function">setCredentials</span><span class="token punctuation">(</span><span class="token string">&quot;api-userName:api-password&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FieldName</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> params <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">TerminalReq<span class="token punctuation">.</span>RequestType</span><span class="token punctuation">,</span> <span class="token class-name">RequestType</span><span class="token punctuation">.</span><span class="token constant">SALE</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">TerminalReq<span class="token punctuation">.</span>Amount</span><span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">TerminalReq<span class="token punctuation">.</span>TransactionCode</span><span class="token punctuation">,</span> <span class="token string">&quot;0000000001&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">TerminalAPI</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// In TerminalAPI class</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">exec</span><span class="token punctuation">(</span><span class="token class-name">Activity</span> activity<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FieldName</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> params<span class="token punctuation">,</span> <span class="token class-name">Integer</span> requestCode<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">Intent</span> intent <span class="token operator">=</span> <span class="token function">locateTerminalAppApplication</span><span class="token punctuation">(</span>activity<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// Validations skipped</span></span>
<span class="line">        params<span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span>defaults<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        intent<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span><span class="token class-name">Fields</span><span class="token punctuation">.</span><span class="token constant">PARAMS</span><span class="token punctuation">,</span> <span class="token function">convertRequestMap</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        intent<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span><span class="token class-name">Fields</span><span class="token punctuation">.</span><span class="token constant">CREDENTIALS</span><span class="token punctuation">,</span> credentials<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        intent<span class="token punctuation">.</span><span class="token function">setFlags</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        activity<span class="token punctuation">.</span><span class="token function">startActivityForResult</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> requestCode<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">throw</span> <span class="token class-name">UniPayException</span><span class="token punctuation">.</span><span class="token function">s20</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TerminalReceiver</span> <span class="token keyword">extends</span> <span class="token class-name">BroadcastReceiver</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">ACTION_TERMINALAPP_RESPONSE</span> <span class="token operator">=</span> <span class="token string">&quot;ACTION_TERMINALAPP_RESPONSE&quot;</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">ACTION_TERMINALAPP_STATUS</span> <span class="token operator">=</span> <span class="token string">&quot;ACTION_TERMINALAPP_STATUS&quot;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onReceive</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">Intent</span> intent<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">SharedPreferences</span> prefs <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getSharedPreferences</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;_preferences&quot;</span><span class="token punctuation">,</span> <span class="token constant">MODE_PRIVATE</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">String</span> action <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>action <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">switch</span> <span class="token punctuation">(</span>action<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">case</span> <span class="token constant">ACTION_TERMINALAPP_STATUS</span><span class="token operator">:</span></span>
<span class="line">                    <span class="token comment">//...</span></span>
<span class="line">                    <span class="token keyword">break</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token keyword">case</span> <span class="token constant">ACTION_TERMINALAPP_RESPONSE</span><span class="token operator">:</span></span>
<span class="line">                    <span class="token class-name">String</span> responseStr <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getStringExtra</span><span class="token punctuation">(</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token keyword">if</span> <span class="token punctuation">(</span>responseStr <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                        <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">                            <span class="token class-name">PayResult</span> payResult <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PayResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                            <span class="token class-name">TransactionResponse</span> transactionResponse <span class="token operator">=</span> <span class="token class-name">TransactionResponse</span><span class="token punctuation">.</span><span class="token function">fromJSON</span><span class="token punctuation">(</span>responseStr<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                            <span class="token class-name">String</span> responseCode <span class="token operator">=</span> transactionResponse<span class="token punctuation">.</span><span class="token function">getResponseCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                            <span class="token class-name">String</span> returnStr <span class="token operator">=</span> transactionResponse<span class="token punctuation">.</span><span class="token function">getResponseMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                            <span class="token keyword">if</span> <span class="token punctuation">(</span>responseCode <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>responseCode<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;A01&quot;</span><span class="token punctuation">)</span> <span class="token operator">||</span> responseCode<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;A02&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                                payResult<span class="token punctuation">.</span>approved <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></span>
<span class="line">                                payResult<span class="token punctuation">.</span>reciept <span class="token operator">=</span> prefs<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">&quot;merchant_name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;\n&quot;</span> <span class="token operator">+</span> prefs<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">&quot;merchant_regno&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;\n\n&quot;</span> <span class="token operator">+</span> emvData<span class="token punctuation">;</span></span>
<span class="line">                            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">                                <span class="token comment">// ...</span></span>
<span class="line">                            <span class="token punctuation">}</span></span>
<span class="line">                        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                            <span class="token comment">// Handle exception</span></span>
<span class="line">                        <span class="token punctuation">}</span></span>
<span class="line">                    <span class="token punctuation">}</span></span>
<span class="line">                    <span class="token keyword">break</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token keyword">default</span><span class="token operator">:</span></span>
<span class="line">                    <span class="token keyword">break</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p><strong>Note!</strong> Pseudo code above demonstrates principles of handling transaction response with a support of Broadcast Receiver component and specific actions transmitted from a Terminal App. An alternative handling scenario would imply processing of data returned in activity onActivityResult callback as a result of startActivityForResult call initiated before.</p></blockquote><p>Please refer to the <a href="#source-code-examples">Examples</a> section for getting references to an example implementation of the POS Client Demo application.</p><h2 id="proxy-mode" tabindex="-1"><a class="header-anchor" href="#proxy-mode"><span>Proxy Mode</span></a></h2><h3 id="overview-1" tabindex="-1"><a class="header-anchor" href="#overview-1"><span>Overview</span></a></h3><p>Proxy mode is an advanced solution that takes managed mode to the next level. To use it, you must install a small Android app on the payment device where Terminal App lives and transfer the data from the payment application into a TCP/IP socket stream. This allows the cash register (POS) to communicate with the payment device over four different network carriers: Wi-Fi, wired Ethernet, Bluetooth tethering, and USB cable tethering. Bluetooth and USB cable tethering also allow sharing the 4G mobile connection with the cash register, which is perfect for situations where DSL or fiber optic connections are not accessible.</p><p>The proxy mode uses an application that listens for any connection on a specific port. Whatever comes in the socket is relayed to the <em>Intent</em>, just like in the managed mode example. The result coming back from the intent is then sent back to the calling cash register’s (POS) TCP/IP socket. The data format of the data sent and received will be the same as in managed mode, except conversion and delivery in JSON format.</p><p>The benefits of using proxy mode are:</p><ul><li><p>Works independently of network carriers.</p></li><li><p>Provides blazing-fast communication.</p></li><li><p>Allows the use of the payment device&#39;s screen as a marketing device, which can even be interactive.</p></li><li><p>Enables wiring the device to a PC with a USB cable for charging and data communication.</p></li><li><p>Ideal for 4G operation with USB or Bluetooth option.</p></li><li><p>More stable, as it does not require a stable internet connection.</p></li></ul><p>However, there are some cons to consider:</p><ul><li><p>Requires more development resources</p></li><li><p>Needs more initial configuration</p></li></ul><p>The illustration below shows how the interactions between POS and Tidypay components take place in this mode:</p><p><img src="/assets/qav_Image_4-Bgp7rK9o.png" alt="Enter image alt description"></p><blockquote><p><strong>Note!</strong> Proxy App becomes a responsibility of a POS integrator to develop and maintain. Even though it is a lightweight application, it has to support proper transfers of data structures using TCP/IP protocol from/to Intents data communicated with Terminal App.</p></blockquote><h3 id="features-1" tabindex="-1"><a class="header-anchor" href="#features-1"><span>Features:</span></a></h3><ul><li><p>High-speed transactions over local networking (Wi-Fi, USB, Bluetooth).</p></li><li><p>Ideal for high-volume retail or Electronic Cash Register (ECR) integrations.</p></li></ul><h3 id="technical-considerations-1" tabindex="-1"><a class="header-anchor" href="#technical-considerations-1"><span>Technical considerations</span></a></h3><p>Data is formatted as JSON and transmitted via a socket to the terminal.</p><p>An example below contains a pseudo code that forms a Sale request:</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">processSaleRequestProxy</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> amount<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FieldName</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> params <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">TerminalReq<span class="token punctuation">.</span>RequestType</span><span class="token punctuation">,</span> <span class="token class-name">RequestType</span><span class="token punctuation">.</span><span class="token constant">SALE</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">TerminalReq<span class="token punctuation">.</span>Amount</span><span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token function">convertRequestMap</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SendReceiveIP</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">JSONObject</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p><strong>Note!</strong> It is worth pointing out that the example above resembles to a large extent the code for managed mode. And this is true as a bulk of differences lie in the conversion of a map to JSON and then transporting it via TCP/IP routine.</p></blockquote><h1 id="broadcastreceiver-integration" tabindex="-1"><a class="header-anchor" href="#broadcastreceiver-integration"><span>BroadcastReceiver Integration</span></a></h1><p>This component is essentially a back channel for pushing Terminal App transaction updates down to the POS system.</p><p>BroadcastReceiver&#39;s goal is to subscribe to notifications coming from the Terminal App and react correspondingly in the POS system.</p><p>Two types of actions/notifications are supported:</p><h2 id="transaction-responses" tabindex="-1"><a class="header-anchor" href="#transaction-responses"><span>Transaction Responses</span></a></h2><ul><li><p><strong>Action Name:</strong> <em><strong>ACTION_TERMINALAPP_RESPONSE</strong></em></p></li><li><p><strong>Content</strong>: Includes transaction response details in JSON format similar to the API server response.</p></li></ul><p><img src="/assets/QG9_Image_5-C8J2affu.png" alt="Enter image alt description"></p><h2 id="status-notifications" tabindex="-1"><a class="header-anchor" href="#status-notifications"><span>Status Notifications</span></a></h2><ul><li><p><strong>Action Name</strong>: <em><strong>ACTION_TERMINALAPP_STATUS</strong></em></p></li><li><p><strong>Content:</strong> Carries information about a certain screen displayed on the terminal</p></li><li><p><strong>Data format:</strong></p></li></ul><table><thead><tr><th>Field</th><th>Description</th><th>Possible Values</th></tr></thead><tbody><tr><td>screenCode</td><td>The screen displayed in the Terminal App</td><td>&#39;<em>present-card</em>&#39;, &#39;<em>enter-pin</em>&#39;, &#39;<em>select-application</em>&#39;, &#39;<em>visualize-result</em>&#39;, &#39;<em>provide-signature</em>&#39;, &#39;<em>confirm-signature</em>&#39;</td></tr><tr><td>entryMode</td><td>Possible payment methods</td><td>&#39;<em>tap</em>&#39;, &#39;<em>insert</em>&#39;, &#39;<em>swipe</em>&#39;, &#39;<em>manual</em>&#39;, &#39;<em>tap|insert</em>&#39;, &#39;<em>tap|swipe</em>&#39;, &#39;<em>tap|manual</em>&#39;, &#39;<em>insert|swipe</em>&#39;, &#39;<em>insert|manual</em>&#39;, &#39;<em>swipe|manual</em>&#39;, &#39;<em>tap|insert|swipe</em>&#39;, &#39;<em>tap|insert|manual</em>&#39;, &#39;<em>tap|swipe|manual</em>&#39;, &#39;<em>insert|swipe|manual</em>&#39;, &#39;<em>tap|insert|swipe|manual</em>&#39;</td></tr><tr><td>screenMessage</td><td>Title or message on the screen.The parameter corresponds to the text of the current screen except for the screen Tap, Insert or Swipe</td><td></td></tr></tbody></table><p><strong>Code Example</strong></p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TerminalAppResponseReceiver</span> <span class="token keyword">extends</span> <span class="token class-name">BroadcastReceiver</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onReceive</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">Intent</span> intent<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">String</span> response <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getStringExtra</span><span class="token punctuation">(</span><span class="token string">&quot;response&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">&quot;TerminalResponse&quot;</span><span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="comparison-of-integration-modes" tabindex="-1"><a class="header-anchor" href="#comparison-of-integration-modes"><span><strong>Comparison of Integration Modes</strong></span></a></h2><table><thead><tr><th>Feature</th><th>Managed Mode</th><th>Proxy Mode</th></tr></thead><tbody><tr><td>Ease of Use</td><td>Medium</td><td>Low</td></tr><tr><td>Device Dependency</td><td>Yes</td><td>No</td></tr><tr><td>Transaction Speed</td><td>Fast</td><td>Fast</td></tr><tr><td>Stability</td><td>Very High</td><td>High</td></tr><tr><td>Setup Complexity</td><td>Easy</td><td>Medium</td></tr><tr><td>Support Requirements</td><td>Low</td><td>Medium</td></tr><tr><td>Flexibility</td><td>Medium</td><td>Very High</td></tr></tbody></table><h1 id="cross-cutting-concerns" tabindex="-1"><a class="header-anchor" href="#cross-cutting-concerns"><span>Cross-cutting concerns</span></a></h1><h2 id="api-authentification" tabindex="-1"><a class="header-anchor" href="#api-authentification"><span>API Authentification</span></a></h2><p>In each API call <em><strong>userName</strong></em> and <em><strong>password</strong></em> shall be provided.</p><p>The respective credentials shall be requested from Tidypay.</p><p>The password to be provided is static and is not rotated.</p><h2 id="identification-of-the-transactions" tabindex="-1"><a class="header-anchor" href="#identification-of-the-transactions"><span>Identification of the transactions</span></a></h2><p><em>Transaction Code</em> parameter is recommended to be used for identification of the transaction within an external system. e.i. POS, that submits the transaction for processing. This allows for cross-referencing of entities between the Tidypay system and a submitter’s (POS) system.</p><p>This allows POS to request information about the transactions or make commands using *Transaction Code *when sending to Tidypay rather than using internal *TransactionID *(which is a Tidypay identifier). This, in-turn, also ensures that the POS and Tidypay can be reconciled properly.</p><h2 id="duplicate-transaction-handling" tabindex="-1"><a class="header-anchor" href="#duplicate-transaction-handling"><span>Duplicate Transaction handling</span></a></h2><p>The Tidypay system supports different policies of how <em>Sale</em> transactions behave in case the same <em>Transaction Code</em> is passed.</p><p><img src="/assets/5g1_Image_6-0BDWwfXO.png" alt="Enter image alt description"></p><blockquote><p><strong>Note!</strong> &quot;Return existing transaction&quot; option is recommended. This way, the POS will always receive the &#39;correct&#39; response, including if it turns out to be a duplicated transaction.</p></blockquote><p>Let’s review scenarios when POS conducts two real-time transactions through usage of *Transaction Code *under different Transaction Duplicated Policy settings applied.</p><p>Let&#39;s assume that the first transaction (TR1) with a certain transactionCode (TC) was posted using the <em>Sale</em> API. We will check how the system processes a request to post a second transaction (TR2) with the same transactionCode (TC), considering the status of the first transaction (TR1): <em>Approved, Declined, Voided,</em> or <em>Refunded</em>.</p><h3 id="setting-no-duplicates-check-on" tabindex="-1"><a class="header-anchor" href="#setting-no-duplicates-check-on"><span>Setting: <em>No duplicates check</em> = ON</span></a></h3><table><thead><tr><th>Case #</th><th>Precondition</th><th>Test</th><th>Result</th></tr></thead><tbody><tr><td>1</td><td>TR1 = Approved</td><td>POST requestType=Sale with the same TC</td><td>TR2 is posted:</td></tr><tr><td>responseCode=A01</td><td></td><td></td><td></td></tr><tr><td>responseMessage=Approved</td><td></td><td></td><td></td></tr><tr><td>2</td><td>TR1 = Decline</td><td>POST requestType=Sale with the same TC</td><td>TR2 is posted:</td></tr><tr><td>responseCode=A01</td><td></td><td></td><td></td></tr><tr><td>responseMessage=Approved</td><td></td><td></td><td></td></tr><tr><td>3</td><td>TR1 = Void</td><td>POST requestType=Sale with the same TC</td><td>TR2 is posted:</td></tr><tr><td>responseCode=A01</td><td></td><td></td><td></td></tr><tr><td>responseMessage=Approved</td><td></td><td></td><td></td></tr><tr><td>4</td><td>TR1 = Refund</td><td>POST requestType=Sale with the same TC</td><td>TR2 is posted:</td></tr><tr><td>responseCode=A01</td><td></td><td></td><td></td></tr><tr><td>responseMessage=Approved</td><td></td><td></td><td></td></tr></tbody></table><blockquote><p><strong>Note!</strong> If there are multiple transactions with the same Transaction Code, then the requestType=find returns the ID of the most recently posted transaction.</p></blockquote><h3 id="setting-decline-if-duplicate-on" tabindex="-1"><a class="header-anchor" href="#setting-decline-if-duplicate-on"><span>Setting: <em>Decline if duplicate</em> = ON</span></a></h3><table><thead><tr><th>Case #</th><th>Precondition</th><th>Test</th><th>Result</th></tr></thead><tbody><tr><td>1</td><td>TR1 = Approved</td><td>POST requestType=Sale with the same TC</td><td>responseCode=V29</td></tr><tr><td>responseMessage= <br> The transaction you are trying to process is a duplicate of a recently processed transaction</td><td></td><td></td><td></td></tr><tr><td>2</td><td>TR1 = Decline</td><td>POST requestType=Sale with the same TC</td><td>responseCode=V29</td></tr><tr><td>responseMessage= <br> The transaction you are trying to process is a duplicate of a recently processed transaction</td><td></td><td></td><td></td></tr><tr><td>3</td><td>TR1 = Void</td><td>POST requestType=Sale with the same TC</td><td>responseCode=V29</td></tr><tr><td>responseMessage= <br> The transaction you are trying to process is a duplicate of a recently processed transaction</td><td></td><td></td><td></td></tr><tr><td>4</td><td>TR1 = Refund</td><td>POST requestType=Sale with the same TC</td><td>responseCode=V29</td></tr><tr><td>responseMessage= <br> The transaction you are trying to process is a duplicate of a recently processed transaction</td><td></td><td></td><td></td></tr></tbody></table><h3 id="setting-return-existing-transaction-on" tabindex="-1"><a class="header-anchor" href="#setting-return-existing-transaction-on"><span>Setting: <em>Return existing transaction</em> = ON</span></a></h3><table><thead><tr><th>Case #</th><th>Precondition</th><th>Test</th><th>Result</th></tr></thead><tbody><tr><td>1</td><td>TR1 = Approved</td><td>POST requestType=Sale with the same TC</td><td>TR1 is returned in the response</td></tr><tr><td>2</td><td>TR1 = Decline</td><td>POST requestType=Sale with the same TC</td><td>responseCode=V29</td></tr><tr><td>responseMessage=The transaction you are trying to process is a duplicate of a recently processed transaction</td><td></td><td></td><td></td></tr><tr><td>3</td><td>TR1 = Void</td><td>POST requestType=Sale with the same TC</td><td>responseCode=V29</td></tr><tr><td>responseMessage=The transaction you are trying to process is a duplicate of a recently processed transaction</td><td></td><td></td><td></td></tr><tr><td>4</td><td>TR1 = Refund</td><td>POST requestType=Sale with the same TC</td><td>responseCode=V29</td></tr><tr><td>responseMessage=The transaction you are trying to process is a duplicate of a recently processed transaction</td><td></td><td></td><td></td></tr></tbody></table><blockquote><p><strong>Note!</strong> requestType=find through Transaction Code returns the transaction data regardless of the payment result.</p></blockquote></div><!--[--><!--]--></div><footer class="vp-page-meta"><!----><div class="vp-meta-item git-info"><!----><!----></div></footer><!----><!--[--><!--]--></main><!--]--></div><!--[--><!----><!--]--><!--]--></div>
    <script type="module" src="assets/app-DFSrrxbA.js" defer></script>
  </body>
</html>
